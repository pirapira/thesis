\chapter{A Terminating Tableau System for Sequential Consistency Logic}

  \subsection{Investigating Proof Searching}
  There are two kinds of computational interpretations for propositional
  logics: one is lambda calculi, the other is proof search.
  In this chapter, we investigate the proof search for the sequential
  consistency logic.  We succeed in developing a terminating tableau
  system for sequential consistency logic and thus obtain a decision
  procedure for satisfiability of formulae in the sequential consistency
  logic.  Unfortunately, we do not find any concurrently executable
  components in this proof search except the obvious method of
  searching different branches in parallel.  The concurrent computational
  perspective will be apparent in the next chapter when we develop the
  lambda calculi.

 We prove finite model property for sequential consistency logic
 using analytic tableaux.
 The target logic have Kripke frames where modalities are interpreted as
 functions over the frame.  Moreover, each logic is parametrized by a
 set of restrictions.  Each restriction is a disjunction of some
 inequalities posing restrictions on the shape of the frame.

 The target class of intermediate modal logics is a generalization of
 intuitionistic epistemic logic proposed by Hirai~\cite{hirailpar}.
 He used intuitionistic epistemic logic in order to model shared memory
 consistencies, which are criteria that guarantees levels of
 synchronization among different processes.
 Both shared memory consistencies and some intermediate modal logics
 can be characterized as a restriction on
 partially-ordered structure:
 Kripke frames for intermediate modal logics
 and executions for shared memory
 consistencies~\cite{steinke2004unified}.
 He regarded Kripke frames as executions in order to translate
 an intermediate modal logic into a shared memory
 consistency.

 However, he did not show finite model property for those
 intermediate modal logics.  When software engineers talk about shared
 memory consistencies, they assume an execution is finite.
 When we think of Kripke models as executions, we are obliged to show
 that the model is finite.
 Especially when we want to construct a specific counterexample execution,
 we have to build a \textit{finite} Kripke model.

 For example,
 under {sequential consistency logic}, which is intuitionistic epistemic
 logic along with the axioms of the form
 $(K_m\varphi\supset K_m\psi) \vee (K_m\psi\supset K_m\varphi)$,
 the formula $K_aK_mK_aI \supset K_bK_mK_bJ\supset K_bI$ is not a
 theorem.
 In terms of shared memory consistency, this means that even when a
 process~$a$ has put information~$I$ on the shared memory and got a
 successful acknowledgement from the shared memory and the other
 process~$b$ does the same with information~$J$, it is not always the
 case that process~$b$ has obtained information~$I$\kern -2pt.
 Indeed, a finite execution can be constructed using
 finite model property for sequential consistency logic.
 We show this finite model property in a generalized form using the
 method of terminating tableau.

  \section{The Target Logics}
  \label{logic}

  The class of logics that we consider is a generalization of
  intuitionistic propositional logic.
  The class of logics also contains G\"{o}del--Dummett logic~\cite{dummett59}
  and the intuitionistic epistemic logic proposed by
  Hirai~\cite{hirailpar}.
  Let us assume that
  there are a countably infinite set~$\pvar$ of propositional
  variables\index{variable!propositional}\index{propositional variable|see{variable}} and a
  finite set~$\agents$ of agents\index{agent}.

  \begin{definition}
   We define the set~$\fml$ of formulae by BNF:
   \[
   \varphi,\psi ::= \bot\mid I\mid K_a\varphi\mid (\varphi\vee\psi)\mid
   (\varphi\land\psi)\mid (\varphi\supset\psi)
   \]
   where $a$ is an agent in $\agents$
   and $I$ is a propositional variable in~$\pvar$.
  \end{definition}

  For a set of formulae $\Gamma\!$, notation $K_a\Gamma$ denotes the set
  $\{K_a\varphi\mid\varphi\in\Gamma\}$\enspace.

  \begin{definition}[Kripke frame]
   A frame\index{frame} $\tuple{W,\preceq,(f_a)_{a\in \agents}}$ is a tuple where
   \begin{itemize}
    \item $\tuple{W,\preceq}$ is a partially ordered set, and
    \item each $f_a\colon W\rightarrow W$ is a monotonic function with
	  respect to~$\preceq$.
   \end{itemize}
  \end{definition}

  \begin{definition}[Kripke model]
   A model\index{model} $\tuple{W,\preceq, (f_a)_{a\in \agents},\rho}$ is a tuple where
   \begin{itemize}
    \item $\tuple{W,\preceq,(f_a)_{a\in \agents}}$ is a frame, and
    \item $\rho\colon \pvar\rightarrow 2^W$ is a function that maps every
	  propositional variable to a upward-closed subset of $W\!$.
   \end{itemize}
  \end{definition}

  We are going to prove finite model property for a class of
  intermediate modal logics.  The logics are parametrized with
  world restriction sets,  which we are going to define.
  We assume that there is a countably infinite set of world variables\index{world
  variables}~$\wvar$.
  We use $\mathsf v, \mathsf w,\ldots$ to denote world variables.
  We define world terms\index{term!world}\index{world term|see {term}} using BNF:
  \[
  \mathsf s::=\mathsf v\mid \mathsf s.a
  \]
  where $a$ is an agent.
  Every world term can be written as $\mathsf v.s$ where $s$ is a fintie sequence
  of agents (a postfix).
  A world inequality\index{world inequality} is an inequation of the form $\mathsf s\le
  \mathsf t$ where $\mathsf s$ and $\mathsf t$ are world terms.
  \begin{definition}
   A world restriction is a sequence of world inequalities jointed
   by~$\wor$ formed like
   $\mathsf v_0.s_0\le\mathsf v_1.t_1\wor\cdots\wor
   \mathsf v_{n-1}.s_{n-1}\le\mathsf v_n.t_n\wor \mathsf v_n.s_n\le\mathsf
   v_0.t_0$ that satisfies either
   \begin{itemize}
    \item (single clause) $n=0$, or
    \item (single postfix) $s_i = t_i = s_j = t_{j}$ for $0\le i,j\le n$.
   \end{itemize}
  \end{definition}
  The condition of world restrictions being single clause or single
  postfix will be used in the proof of soundness (\thref{sound-nat-kripke}).
  A world restriction set\index{world restriction set} is a finite set of world restrictions.

  A world valuation\index{world valuation} maps a world variable into a world of a frame.
  We extend a world valuation on world variables
  $\delta\colon\mathcal V_W\rightarrow W$ to that on world terms
  inductively as $\delta(\mathsf s.a)=f_a(\delta(\mathsf s))$.
  A frame $\tuple{W,\preceq, 1,(f_a)_{a\in\agents}}$ satisfies a world inequality
  $\mathsf s\le\mathsf t$ iff $\delta(\mathsf s)\preceq \delta(\mathsf t)$
  for all $\delta\colon\mathcal V_W\rightarrow W$.
  A frame~$F$ satisfies a world restriction $\mathsf r$
  iff $M$ satisfies $\delta(\mathsf r)$ for any world valuation~$\delta$.
  For example, a frame satisfies $\mathsf v\le \mathsf w\wor\mathsf
  w\le\mathsf v$ iff the frame is totally ordered.
  An $\mathsf R$-frame is a frame that
  satisfies all world restrictions in~$\mathsf R$.
  An $\mathsf R$-model is a model with an $\mathsf R$-frame.


  \begin{definition}
   We define the satisfaction relation\index{satisfaction} $M,w\models\varphi$ over a model
   $M = \tuple{W,\preceq,(f_a)_{a\in \agents},\rho}$, a state~$w\in W$ and a
   formula~$\varphi$ inductively on $\varphi$.
   In this definition, let
   us abbreviate $M,w\models \varphi$ into $w\models \varphi$\enspace.
   \newcommand{\m}{}
   \begin{itemize}
    \item $w\models \bot$ never holds.
    \item $w\models I$ iff
	  $w \in
	  \rho(I)$.
    \item	    $w\models K_a \psi$ iff
		    $f_a(w)\models \psi$.
    \item $w\models \psi_0\land\psi_1$ iff both
	  $w\models \psi_0$ and $w\models \psi_1$ hold.
    \item
	 $ w\models \psi_0\vee\psi_1$ iff either
	 $ w\models \psi_0$ or $w\models \psi_1$ holds.
    \item
	 $w\models \psi_0\supset\psi_1$ iff
	 $w'\succeq w$ and $w'\models \psi_0$ imply
	 $w'\models\psi_1$ for any $w'\in W$\enspace.
   \end{itemize}
  \end{definition}
  A model~$M$ satisfies\index{satisfy} $\varphi$ iff $M,w\models\varphi$ holds for any
  state~$w$ of~$M$.
  A formula~$\varphi$ is \index{valid under} $\mathsf R$ iff
  every $\mathsf R$-model~$M$ satisfies $M\models \varphi$.
  For this, we write $\modelsR \varphi$\enspace.

  \begin{proposition}[Kripke monotonicity]
   \label{monot}
   $M,w\models\varphi$ and $w\preceq v$ imply
   $M,v\models\varphi$.
  \end{proposition}
  \begin{proof}
   Induction on~$\varphi$.
   We use monotonicity of $f_a$ here.
  \end{proof}

    \paragraph{The proof system.}
    Since both $\pvar$ and $\wvar$ are countably infinite,
    there is an injection that maps a world variable to a propositional
    variable.
    We fix one such injection
    $\mathsf w\mapsto I_{\mathsf w}$.
    Inductively on the construction of world terms,
    we assign a formula~$[\mathsf t]$ to every world term~$\mathsf t$:
    \begin{itemize}
     \item for a world term $\mathsf w\in \wvar$, we define $[\mathsf w]$ to be
	   $I_{\mathsf w}$,
     \item for a world term $\mathsf{s.a}$, we construct
	   a formula $[\mathsf{s.a}]$ by
	   replacing every propositional variable~$P$ with $K_aP$ in $[\mathsf s]$.
    \end{itemize}
    Note that the sequence $\mathsf{.a.b.c}$ is translated into the same
    order $K_a K_b K_c$ although a postfix is translated into a prefix.
    We define $K_s\varphi$ as $[\mathsf w.s][\varphi/I_{\mathsf w}]$.
    Also, we define $f_b\circ f_a$ as $f_{ab}$.  This ensures $M, w\models
    K_s\varphi\Leftrightarrow M,f_s(w)\models\varphi$.

    This translation of world terms into formulae
    enables us to translate world inequalities and world restrictions
    into formulae:
    \begin{itemize}
     \item $[\mathsf s\le \mathsf t] := [\mathsf s]\supset [\mathsf t]$, and
     \item $[\mathsf{s_0}\le \mathsf{t_0}\wor \cdots\wor \mathsf{s_n}\le \mathsf{t_n}] := [\mathsf{s_0}\le \mathsf{t_0}]\vee
	   \cdots \vee [\mathsf{s_n}\le \mathsf{t_n}]$ \enspace.
    \end{itemize}

    We define $\mathbf{Ax}(\mathsf R)$ to be the substitution closure of
    $\{[\mathsf r]\mid \mathsf r\in \mathsf R\}$.
    The substitution closure of a set~$S$ of formulae is defined as
    $\{\phi[\psi/P]\mid \phi\in S\}$ where $\psi$ run freely on~$\fml$ and $P$ on~$\pvar$.

    \begin{figure}[t]
     \centering
      \def\fCenter{\vdashR}
      \AxiomC{}
      \LeftLabel{(axiom)}
      \UnaryInf$\varphi \fCenter \varphi$
      \DisplayProof
      \hfill
      \Axiom$\Gamma\fCenter\varphi$
      \LeftLabel{(weakening)}
      \UnaryInf$\psi,\,\Gamma\fCenter\varphi$
      \DisplayProof
      \hfill
      \Axiom$ \varphi,\,\varphi,\,\Gamma\fCenter\psi$
      \LeftLabel{(contraction)}
      \UnaryInf$\varphi,\,\Gamma\fCenter\psi$
      \DisplayProof
      \ruleskip
      \Axiom$\Gamma, \varphi,\psi,\, \Gamma'\fCenter\theta$
      \LeftLabel{(exchange)}
      \UnaryInf$\Gamma,\,\psi,\varphi,\,\Gamma'\fCenter\theta$
      \DisplayProof
      \hfill
      \Axiom$\Gamma\fCenter\varphi$
      \Axiom$\Gamma'\fCenter\psi$
      \LeftLabel{($\wedge$-I)}
      \BinaryInf$\Gamma,\Gamma'\fCenter \varphi\land\psi$
      \DisplayProof
      \hfill
      \Axiom$\Gamma\fCenter \varphi$
      \LeftLabel{($\vee$-I$_0$)}
      \UnaryInf$\Gamma\fCenter \varphi\vee\psi$
      \DisplayProof
      \ruleskip
      \Axiom$\Gamma\fCenter \varphi$
      \LeftLabel{($\vee$-I$_1$)}
      \UnaryInf$\Gamma\fCenter \psi\vee\varphi$
      \DisplayProof
      \hfill
      \Axiom$\Gamma \fCenter\varphi\land\psi$
      \LeftLabel{($\wedge$-E$_0$)}
      \UnaryInf$\Gamma\fCenter \varphi$
      \DisplayProof
      \hfill
      \Axiom$\Gamma\fCenter \varphi\land\psi$
      \LeftLabel{($\wedge$-E$_1$)}
      \UnaryInf$\Gamma\fCenter \psi$
      \DisplayProof
      \ruleskip
      \Axiom$\Gamma\fCenter \psi_0\vee\psi_1$
      \Axiom$\Gamma,\,\psi_0\fCenter \varphi$
      \Axiom$\Gamma,\,\psi_1\fCenter \varphi$
      \LeftLabel{($\vee$-E)}
      \TrinaryInf$\Gamma\fCenter \varphi$
      \DisplayProof
      \vskip 5mm
      \Axiom$\varphi,\,\Gamma\fCenter\psi$
      \LeftLabel{($\supset$-I)}
      \UnaryInf$\Gamma\fCenter \varphi\supset\psi$
      \DisplayProof
      \hfill
      \Axiom$\Gamma\fCenter\psi_0\supset\psi_1$
      \Axiom$\Gamma\fCenter \psi_0$
      \LeftLabel{($\supset$-E)}
      \BinaryInf$\Gamma\fCenter \psi_1$
      \DisplayProof
      \hfill
      \Axiom$\Gamma\fCenter\bot$
      \LeftLabel{($\bot$-E)}
      \UnaryInf$\Gamma\fCenter\varphi$
      \DisplayProof
      \ruleskip
      \AxiomC{}
      \LeftLabel{($\vee K$)}
      \UnaryInf$K_a(\varphi\vee\psi)\fCenter (K_a \varphi)\vee K_a\psi$
      \DisplayProof
      \hfill
      \AxiomC{}
      \LeftLabel{($\mathbf{Ax}$)}
      \RightLabel{($\varphi\in \mathbf{Ax}(\mathsf R)$)}
      \UnaryInf$\fCenter\varphi$
      \DisplayProof
      \ruleskip
      \Axiom$\Gamma\fCenter\varphi$
      \LeftLabel{(necessitation)}
      \UnaryInf$K_a\Gamma\fCenter K_a\varphi$
      \DisplayProof
     \caption{Deduction rules of $\vdashR$.}
     \label{figR}
    \end{figure}

    \begin{definition}
     We define the proof system $\vdashR$ by Figure~\ref{figR}.
    \end{definition}

    \begin{theorem}
     \label{sound-comp-nat-kripke}
     $\Gamma\vdashR\varphi\Longleftrightarrow\Gamma\modelsR \varphi$\enspace.
    \end{theorem}
    \begin{lemma}[Soundness]
     \label{sound-nat-kripke}
     $\Gamma\modelsR\varphi\Longleftarrow\Gamma\vdashR\varphi$
    \end{lemma}
    \begin{proof}
     We show $\Gamma\modelsR\varphi$ inductively
     on the definition of $\Gamma\vdashR\varphi$.
     \begin{description}
      \item[(Case {Ax})]
	   Suppose $\varphi\in \mathsf{Ax}(R)$.
	   For an $\mathsf{R}$-model~$M$ and a state~$w$ of~$M$,
	   we are going to show $M,w\models\varphi$.
	   Seeking contradiction,
	   we assume $M,w\not\models\varphi$.
	   Since $\varphi\in\mathsf{Ax}(R)$, there exists a world
	   restriction $\mathsf r\in\mathsf R$ with
	   $\varphi=[\mathsf r]\theta$,
	   where $\theta$ is a substitution.
	   Let $\mathsf r$ be
	   $\mathsf v_0.s_0\le\mathsf v_1.t_1\wor\cdots\wor
	   \mathsf v_{n-1}.s_{n-1}\le\mathsf v_n.t_n\wor\mathsf
	   v_n.s_n\le\mathsf v_0.t_0$.
	   Then,
	   $\varphi = (K_{s_0}\varphi_0\supset
	   K_{t_1}\varphi_1)\vee\cdots\vee
	   (K_{s_{n-1}}\varphi_{n-1}\supset K_{t_n}\varphi_n)
	   \vee (K_{s_n}\varphi_n\supset K_{t_0}\varphi_0)$
	   for some $(\varphi_i)_{0\le i\le n}$.
	   We define $\varphi_{n+1}$ to be $\varphi_0$ and
	   $\varphi_{-1}$ to be $\varphi_n$.
	   By assumption, $M,w\not\models K_{s_i}\varphi_i\supset
	   K_{t_{i+1}}\varphi_{i+1}$ for any $0\le i\le n$.
	   This implies existence of a sequence
	   $(v_i)_{0\le i\le n}$ of states with $w\preceq v_i$ and
	   $M,v_i\models K_{s_i}\varphi_i$ but $M,v_i\not\models
	   K_{t_{i+1}}\varphi_{i+1}$.
	   By the semantics of modalities, we have
	   $M,f_{s_i}(v_i)\models \varphi_i$ but $M,
	   f_{t_{i+1}}(v_i)\not\models\varphi_{i+1}$
	   for any $0\le i\le n$.
	   When $\mathsf r$ is single clause,
	   $\mathsf r = \mathsf v.s\le\mathsf v.t$.
	   Since $M$ is an $\mathsf R$-model, world valuations mapping
	   $\mathsf v$ to $v_0$ witnesses
	   $f_s(v_0)\preceq f_t(v_0)$.
	   We have $M,v_0\models K_s\varphi_0$ but $M,v_0\not\models
	   K_t\varphi_0$ becasue $n$ is zero.
	   This contradicts Kripke monotonicity.
	   Otherwise, when $\mathsf r$ is single postfix,
	   $\mathsf r = \mathsf v_0.s\le\mathsf
	   v_1.s\wor\cdots\wor\mathsf v_{n-1}.s\le\mathsf
	   v_n.s\wor\mathsf v_n.s\le\mathsf v_0.s$.
	   Let $\delta(\mathsf v_i)$ be $v_{n-i}$.
	   Since $M$ is an $\mathsf R$-model,
	   for some $0\le i\le n$,
	   we have $\delta(\mathsf v_i.s)\preceq \delta(\mathsf
	   v_{i+1}.s)$.
	   This is equivalent to $f_s(v_{n-1})\preceq f_s(v_{n-i-1})$.
	   The way we took $(v_i)_{0\le i\le n}$ ensures
	   $M,v_{n-1}\models K_s\varphi_{n-i}$.
	   In other words, $M,f_s(v_{n-1})\models \varphi_{n-i}$.
	   By Kripke monotonicity, $M,f_s(v_{n-i-1})\models
	   \varphi_{n-i}$.
	   This contradicts $M,f_s(v_{n-i-1})\not\models\varphi_{n-1}$.
      \item[(Other rules)]
	   Straightforward.
     \end{description}
    \end{proof}

   \subsection{Examples}

    \paragraph{G\"{o}del--Dummett logic.}
    When $\mathsf R=\{\mathsf v\le\mathsf w\wor\mathsf w\le\mathsf v\}$,
    the corresponding axioms can be obtained as follows:
    \begin{align*}
     [\mathsf v\le \mathsf w\wor \mathsf w\le\mathsf v] &=
     (I_{\mathsf v}\supset I_{\mathsf w})\vee (I_{\mathsf w}\supset
     I_{\mathsf v})\\
     \mathbf{Ax}(\mathsf R) = \mathbf{Ax}(\{\mathsf v\le\mathsf w\wor \mathsf
     w\le \mathsf v\}) &= \{(\varphi\supset\psi)\vee(\psi\supset\varphi)\mid
     \varphi,\psi\colon\mbox{formula}\}\enspace.
    \end{align*}
    $\mathbf{Ax}(\mathsf R)$ coincides with Dummett's axiom,  Thus,
    $\mathsf R$ characterizes
    G\"{o}del--Dummett logic~\cite{dummett59}.

    \paragraph{Sequential consistency logic.}
    When $\mathsf R=\{\mathsf v.\mathsf m\le\mathsf w.\mathsf m\wor \mathsf
    w.\mathsf m\le \mathsf v.\mathsf m\}$,
    the corresponding set of axioms
    $\mathbf{Ax}(\mathsf R) = \{(K_{\mathsf m}\varphi\supset K_{\mathsf
    m}\psi)\vee(K_{\mathsf m}\psi\supset K_{\mathsf m}\varphi)\mid \varphi,
    \psi\colon\mbox{formula}\}$
    axiomatizes sequential consistency logic,
    which is proposed by Hirai~\cite{hirailpar} for modeling a shared memory consistency called sequential consistency.


  \section{Finite Model Property}
  \label{fmp-proof}

  This is the main technical result of this chapter.
  \begin{corollary}
   \label{thm:fmp}
   $\vdashR\varphi$ holds iff $M\models \varphi$ holds
   for all finite {\sf R}-model $M$.
  \end{corollary}

  We use another deduction system\,\LB\,in order to obtain finite model
  property.
  The outline of the proof is these circular implications:
  \begin{align*}
   \vdashRLB\varphi &\Longrightarrow \quad \models_{\mathsf R}\varphi\quad
   &(\mbox{by \thref{sound}})\\
   &\Longrightarrow \quad \vdash_{\mathsf R}\varphi &(\mbox{by
   \thref{sound-comp-nat-kripke}}) \\
   &\Longrightarrow\quad \modelsR\varphi &\mbox{(by \thref{sound-comp-nat-kripke})}\\
   &\Longrightarrow\quad M\models\varphi \mbox{ for any finite $\mathsf
   R$-model }M\\
   &\Longrightarrow\quad \vdashRLB\varphi & (\mbox{by
   \thref{R-fmp}})\enspace .
  \end{align*}
  This method extends Waaler
  and Wallen's method for intuitionistic first order predicate logic~\cite{waaler1999tableaux}.

   \subsubsection{\LB}

   The deduction system\,\LB\,uses prefixed formulae\index{formula!prefixed}.  A
   prefixed formula is shaped like $\mathsf s::\varphi$ where $\mathsf s $
   is a world term and $\varphi$ is a formula.
   Informally, this prefixed formula means that the formula~$\varphi$ is
   satisfied in a state referenced by~$\mathsf s$.
   A sequent\index{sequent} is shaped like
   $\Theta\parallel \Gamma\longrightarrow \Delta$ where
   $\Theta$ is a finite set of world inequalities (called sidenotes\index{sidenote})
   and both
   $\Gamma$ and $\Delta$ are finite multisets of prefixed formulae so
   that the order in $\G$ and $\D$ are ignored.
   In a sequent, world inequality
   $\mathsf s\le \mathsf s$ must be in $\Theta$
   for any world term $\mathsf s$ occurring in $\Delta$ or $\Gamma$.

   A set~$\Theta$ of world inequalities
   conforms to\index{conforms to} world restriction set~$\mathsf R$ when all of the
   following conditions hold:
   \begin{itemize}
    \item $\mathsf s\le \mathsf t, \mathsf t\le \mathsf u\in
	  \Theta\Longrightarrow
	  \mathsf s\le \mathsf u\in\Theta$,
    \item If $\mathsf{s}_0\le \mathsf{t}_0 \wor \mathsf{s}_1\le \mathsf
	  {t}_1\wor
	  \cdots\wor \mathsf{s}_n\le
	  \mathsf{t}_n$ is in the substitution
	  closure of~$\mathsf R$  and all of
	  $\mathsf{s}_0,\mathsf{s}_1,\ldots,\mathsf{s}_n,
	  \mathsf{t}_0,\mathsf{t}_1,\ldots, \mathsf{t}_n$ appear in~$\Theta$, then,
	  $\mathsf{s}_i\le \mathsf{t}_i\in\Theta$ for at least
	  one~${i}$,
    \item If $\mathsf s\le\mathsf t\in\Theta$ and both $\mathsf s.a$ and
	  $\mathsf t.a$ appear in~$\Theta$, then $\mathsf s.a\le\mathsf
	  t.a\in \Theta$.
   \end{itemize}
   We define $\mathsf R(\Theta)$ to be the set of the minimal
   supersets of~$\Theta$ conforming to~$\mathsf R$.
   For example, when $\mathsf R=\{\mathsf w\le \mathsf v\wor\mathsf v\le \mathsf
   w\}$,
   $\mathsf R(\{\mathsf w\le \mathsf w, \mathsf v\le \mathsf v\}) =
   \{\{\mathsf w\le \mathsf v, \mathsf w\le \mathsf w, \mathsf v \le
   \mathsf v\}, \{\mathsf v \le
   \mathsf w, \mathsf w\le \mathsf w, \mathsf v\le \mathsf v\}\}$\enspace.
   When $\Theta$ is finite, so is $\mathsf R(\Theta)$ because $\mathsf
   R(\Theta)\subseteq \{\mathsf s\le\mathsf
   t\mid\mathsf s,\mathsf t\mbox{ appears in }\Theta\}$.

   \begin{definition}
    The calculus\,\LB\,for a world restriction set~$\mathsf R$ is defined in Figure~\ref{LB}.
    When $\mathsf w\le \mathsf w\parallel \rightarrow \mathsf
    w::\varphi$ is provable in \LB\,for~$\mathsf R$,
    we write $\vdashRLB\varphi$.
   \end{definition}

   \begin{figure}[t]
    \centering
    \def\fCenter{\longrightarrow}
    \small
     \Axiom$\Theta\parallel\Gamma\fCenter \Delta$
     \RightLabel{LT}
     \UnaryInf$\Theta\parallel\mathsf t::\phi,\quad \Gamma\fCenter \Delta$
     \DisplayProof
     \hfill
     \Axiom$\Theta\parallel\Gamma\fCenter \Delta$
     \RightLabel{RT}
     \UnaryInf$\Theta\parallel\Gamma\fCenter \mathsf t::\phi,\quad \Delta$
     \DisplayProof
     \ruleskip
     \Axiom$\Theta\parallel \mathsf t::\phi,\quad \mathsf t::\phi,\quad \Gamma\fCenter \Delta$
     \RightLabel{LC}
     \UnaryInf$\Theta\parallel\mathsf t::\phi,\quad \Gamma\fCenter \Delta$
     \DisplayProof
     \hfill
     \Axiom$\Theta\parallel\Gamma\fCenter \mathsf t::\phi,\quad \mathsf t::\phi,\quad \Delta$
     \RightLabel{RC}
     \UnaryInf$\Theta\parallel\Gamma\fCenter \mathsf t::\phi,\quad \Delta$
     \DisplayProof
     \ruleskip
     \AxiomC{}
     \RightLabel{Ax}
     \UnaryInf$\Theta, \mathsf t\le \mathsf s\parallel \mathsf{s}::\bot\fCenter\mathsf t::\phi$
     \DisplayProof
     \hfill
     \AxiomC{}
     \RightLabel{Ax}
     \UnaryInf$\Theta, \mathsf t\le \mathsf s\parallel \mathsf{s}::\phi\fCenter\mathsf t::\phi$
     \DisplayProof
     \ruleskip
     \Axiom$\Theta\parallel \Gamma\fCenter \mathsf s::\varphi,\quad\Delta$
     \Axiom$\Theta\parallel \Gamma,\quad \mathsf t::\psi \fCenter \Delta$
     \RightLabel{L$\supset$}
     \BinaryInf$\Theta, \mathsf s\le \mathsf t\parallel \Gamma,\quad \mathsf t::\varphi\supset\psi
     \fCenter \Delta$
     \DisplayProof
     \ruleskip
     \Axiom$\Theta'\parallel \Gamma,\quad \mathsf w::\varphi\fCenter
     \mathsf w::\psi,\quad\Delta\quad\mbox{ for every }\Theta'\in \mathsf
     R(\Theta\cup\{\mathsf s\le \mathsf w\})$
     \RightLabel{R$\supset$}
     \UnaryInf$\Theta\parallel \Gamma \fCenter \mathsf s::\varphi\supset\psi,\quad \Delta$
     \DisplayProof\\ ($\mathsf w$ does not appear in the conclusion)
     \ruleskip
     \Axiom$\Theta\parallel\Gamma,\quad \mathsf
     t::\varphi,\quad \mathsf t::\psi\fCenter\Delta$
     \RightLabel{L$\wedge$}
     \UnaryInf$\Theta\parallel\Gamma,\quad \mathsf t::
     \varphi\land \psi\fCenter \Delta$
     \DisplayProof
     \ruleskip
     \Axiom$\Theta\parallel\Gamma\fCenter\mathsf t::\varphi,\quad \Delta$
     \Axiom$\Theta\parallel\Gamma\fCenter\mathsf t::\psi,   \quad \Delta$
     \RightLabel{R$\wedge$}
     \BinaryInf$\Theta\parallel\Gamma\fCenter \mathsf
     t::\varphi\land \psi,\quad \Delta$
     \DisplayProof
     \ruleskip
     \Axiom$\Theta\parallel\Gamma,\quad \mathsf t::\varphi\fCenter\Delta$
     \Axiom$\Theta\parallel\Gamma,\quad \mathsf t::\psi   \fCenter\Delta$
     \RightLabel{L$\vee$}
     \BinaryInf$\Theta\parallel\Gamma,\quad \mathsf
     t::\varphi\vee\psi\fCenter \Delta$
     \DisplayProof
     \ruleskip
     \Axiom$\Theta\parallel\Gamma\fCenter\mathsf
     t::\varphi, \quad\mathsf t::\psi,\quad \Delta$
     \RightLabel{R$\vee$}
     \UnaryInf$\Theta\parallel\Gamma\fCenter\mathsf
     t::\varphi\vee\psi,\quad \Delta$
     \DisplayProof
     \ruleskip
     \Axiom$\Theta\parallel \Gamma,\quad \mathsf s.a::\varphi\fCenter\Delta$
     \RightLabel{L$a$}
     \UnaryInf$\Theta\parallel \Gamma,\quad \mathsf s::K_a\varphi\fCenter\Delta$
     \DisplayProof
     \hfill
     \Axiom$\Theta\parallel \Gamma\fCenter\Delta,\quad \mathsf s.a::\varphi$
     \RightLabel{R$a$}
     \UnaryInf$\Theta\parallel\Gamma\fCenter\Delta,\quad \mathsf s :: K_a\varphi$
     \DisplayProof
    \caption[The inference rules of \LB.]
    {The inference rules of \LB. Modification of Fig.~3 of
    Waaler and Wallen~\cite{waaler1999tableaux}.
    Since $\mathsf R(\Theta\cup\{\mathsf s\le\mathsf w\})$ is finite,
    R$\supset$
    is finitely branching.}
    \label{LB}
   \end{figure}

   \begin{figure}[ht]
    \centering
    \def\fCenter{\longrightarrow}
    \Axiom$\Theta,\mathsf v\le\mathsf x\parallel\mathsf v::\varphi,\mathsf
    x::\psi\fCenter\mathsf v::\psi,\mathsf x::\varphi$
    \Axiom$\Theta,\mathsf x\le\mathsf v\parallel\mathsf v::\varphi,\mathsf
    x::\psi\fCenter\mathsf v::\psi,\mathsf x::\varphi$
    \RightLabel{R$\supset$}
    \BinaryInf$\mathsf w\le\mathsf w,\mathsf w\le\mathsf v,\mathsf
    v\le\mathsf v\parallel\mathsf v::\varphi\fCenter\mathsf v::\psi,\mathsf
    w::\psi\supset\varphi$
    \RightLabel{R$\supset$}
    \UnaryInf$\mathsf w\le\mathsf w\parallel\fCenter\mathsf
    w::\varphi\supset\psi,\mathsf w::\psi\supset\varphi$
    \RightLabel{R$\vee$}
    \UnaryInf$\mathsf w\le\mathsf w\parallel\fCenter\mathsf
    w::(\varphi\supset\psi)\vee(\psi\supset\varphi)$
    \DisplayProof

    \caption[A derivation for
    $\vdashRLB(\varphi\supset\psi)\vee(\psi\supset\varphi)$.]
    {A derivation for
    $\vdashRLB(\varphi\supset\psi)\vee(\psi\supset\varphi)$ where
    $\mathsf R=\{\mathsf v\le\mathsf w,\mathsf w\le\mathsf v\}$.
    In the figure, $\Theta$ stands for $\{\mathsf w\le\mathsf w,\mathsf
    w\le \mathsf v, \mathsf v\le\mathsf v, \mathsf w\le \mathsf x, \mathsf
    x \le \mathsf x\}$. }
    \label{gdlb}
   \end{figure}

  \section{Soundness of LB}

  For a world valuation $\delta:\mathcal V_W\longrightarrow M$,
  we let $\delta(\Theta)$ denote a condition on
  model~$M$ stating $\delta(\mathsf s)\preceq \delta(\mathsf t)$ for any
  $\mathsf s\le \mathsf t\in\Theta$.
  Likewise, $\delta(\mathsf s::\varphi)$ is a condition stating
  $M,\delta(\mathsf s)\models\varphi$.  For a sequence~$\Gamma =
  (t_i::\varphi_i)_{i\in I}$ of
  prefixed formulae, $\delta(\Gamma)$ denotes the conjunction
  of $\delta(t_i::\varphi_i)$ taken over $i\in I$.
   We say a pair
   $\tuple{M,\delta}$ satisfies\index{satisfaction}
   $\Theta\parallel\Gamma\longrightarrow\Delta$ when $\delta(\Theta)$ and
   $\delta(\Gamma)$ implies $\delta(\varphi)$ for some $\varphi$
   in~$\Delta$.

   \begin{proposition}
    \label{exp-sound}
    If an $\mathsf R$-model satisfies $\delta(\Theta)$,
    the model satisfies $\delta(\Theta')$ for
    at least one element~$\Theta'$ of $\mathsf R(\Theta)$.
   \end{proposition}
   \begin{proof}
    Let $\Theta_M$ be the set of world inequalities
    $\{\mathsf s\le \mathsf t\mid M\mbox{
    satisfies }\delta(\mathsf s\le \mathsf t)\}$.
    The set $\Theta_M$ is clearly conforms to $\mathsf R$.
    By definition of $\mathsf R(\Theta)$, there exists at least one $\Theta'\in
    \mathsf R(\Theta)$ with $\Theta'\subseteq \Theta_M$.
    Since $M$ satisfies $\delta(\Theta_M)$, it satisfies $\delta(\Theta')$.
   \end{proof}

   \begin{proposition}
    \label{sound}
    If a sequent $\Theta\parallel \Gamma\longrightarrow \Delta$ is
    provable,
    then, for any $\mathsf R$-model $M$ and world valuation $\delta$,
    the pair~$\tuple{M,\delta}$ satisfies the sequent $\Theta\parallel
    \Gamma\rightarrow\Delta$.
   \end{proposition}
   \begin{proof}
    Induction on derivation trees.
    The case of R$\supset$ is tricky.
    Assume an $\mathsf R$-model~$M$ satisfies all elements of
    $\delta(\Theta)$ and $\delta(\Gamma)$ but no elements of $\delta(\Delta)$.
    In order to prove $M,\delta(\mathsf s)\models\varphi\supset\psi$, we
    arbitrarily take $w\in M$ with $ w\succeq \delta(\mathsf s)$ and assume $M,
    w\models\varphi$.
    Showing $M,w\models\psi$ is enough.
    Let $\mathsf w$ be a world variable which does not occur in~$\Theta$.
    We extend $\delta$ with $\mathsf{w}\mapsto w$ and call the extension~$\epsilon$.
    Since $M$ is an~$\mathsf R$-model,
    it satisfies $\delta(\Theta')$ for some $\Theta'\in \mathsf R(\Theta\cup
    \{\mathsf s\le \mathsf w\})$ by \thref{exp-sound}.
    By induction hypothesis, $M$ satisfies some elements of $\epsilon(\Delta)$ or
    $\epsilon(\mathsf w::\psi)$. Since $\Delta$ does not contain~$\mathsf w$,
    $\epsilon(\Delta)$ is equivalent to $\delta(\Delta)$, of which no elements are
    satisfied by~$M$.
    Thus, $M$ satisfies $\epsilon(\mathsf w::\psi)$.
    Since $\epsilon(\mathsf w) = w$, this means $M,  w\models\psi$.
   \end{proof}

  \section{Finite Model Property of LB}
  \label{fmplb}

  \begin{figure}[t]
   \small
   \centering
    \def\fCenter{\longrightarrow}
    \Axiom$\Theta\parallel\Gamma\fCenter\mathsf t::\varphi,\quad \Delta$
    \RightLabel{R$\wedge_0$}
    \UnaryInf$\Theta\parallel\Gamma\fCenter \mathsf
    t::\varphi\land \psi,\quad \Delta$
    \DisplayProof
    \hfill
    \Axiom$\Theta\parallel\Gamma\fCenter \mathsf t:: \psi,\quad \Delta$
    \RightLabel{R$\wedge_1$}
    \UnaryInf$\Theta\parallel\Gamma\fCenter \mathsf
    t::\varphi\land\psi,\quad\Delta$
    \DisplayProof
    \ruleskip
    \Axiom$\Theta\parallel\Gamma,\quad \mathsf t::\varphi\fCenter\Delta$
    \RightLabel{L$\vee_0$}
    \UnaryInf$\Theta\parallel\Gamma,\quad \mathsf
    t::\varphi\vee\psi\fCenter \Delta$
    \DisplayProof
    \hfill
    \Axiom$\Theta\parallel\Gamma,\quad \mathsf t::\psi\fCenter\Delta$
    \RightLabel{L$\vee_1$}
    \UnaryInf$\Theta\parallel\Gamma,\quad \mathsf
    t::\varphi\vee\psi\fCenter\Delta$
    \DisplayProof
    \ruleskip
    \Axiom$\Theta\parallel\Gamma\fCenter\mathsf
    t::\varphi, \quad\mathsf t::\psi,\quad \Delta$
    \RightLabel{R$\vee$}
    \UnaryInf$\Theta\parallel\Gamma\fCenter\mathsf
    t::\varphi\vee\psi,\quad \Delta$
    \DisplayProof
    \hfill
    \Axiom$\mathsf s\ge \mathsf t,
    \Theta \parallel \Gamma, \quad\mathsf t:: \varphi\supset\psi
    \fCenter\mathsf s:: \varphi, \quad \Delta$
    \RightLabel{LC$\supset_0$}
    \UnaryInf$\mathsf s\ge \mathsf t,\Theta \parallel \Gamma, \quad
    \mathsf t::\varphi\supset\psi\fCenter \Delta$
    \DisplayProof
    \ruleskip
    \Axiom$\Theta\parallel\Gamma,\quad \mathsf
    t::\varphi,\quad \mathsf t::\psi\fCenter\Delta$
    \RightLabel{L$\wedge$}
    \UnaryInf$\Theta\parallel\Gamma,\quad \mathsf t::
    \varphi\land \psi\fCenter \Delta$
    \DisplayProof
    \hfill
    \Axiom$\Theta\parallel\Gamma,\quad\mathsf t::\psi\fCenter \Delta$
    \RightLabel{L$\supset_1$}
    \UnaryInf$\Theta\parallel\Gamma,\quad\mathsf
    t::\varphi\supset\psi\fCenter\Delta$
    \DisplayProof
    \ruleskip
    \Axiom$\Theta'\parallel\Gamma,\quad \mathsf w::\varphi\fCenter
    \mathsf w::\psi,\quad \Delta$
    \RightLabel{R$\supset$}
    \UnaryInf$\Theta\parallel\Gamma\fCenter \mathsf t::\varphi\supset\psi,\quad
    \Delta$
    \DisplayProof\\
    ($\Theta'\in \mathsf R(\Theta\cup \{\mathsf t\le
    \mathsf w\})$ and $\mathsf w$ does not appear in the conclusion)
    \ruleskip
    \Axiom$\Theta'\parallel \Gamma,\quad \mathsf s.a::\varphi\fCenter\Delta$
    \RightLabel{L$a$}
    \UnaryInf$\Theta\parallel \Gamma,\quad \mathsf s::K_a\varphi\fCenter
    \Delta$
    \DisplayProof
    \hfill
    \Axiom$\Theta'\parallel \Gamma\fCenter\Delta,\quad \mathsf s.a::\varphi$
    \RightLabel{R$a$}
    \UnaryInf$\Theta\parallel \Gamma\fCenter\Delta,\quad \mathsf s::K_a \varphi$
    \DisplayProof
    \\
    (in L$a$ and R$a$, $\Theta'\in \mathsf R(\Theta\cup \{\mathsf s.a\le\mathsf s.a\})$)
    \ruleskip
    \Axiom$\Theta\parallel\Gamma
    \fCenter \Delta$
    \RightLabel{LT}
    \UnaryInf$\Theta\parallel\Gamma,\quad
    \mathsf t::\varphi
    \fCenter\Delta$
    \DisplayProof
    \caption[The rules for refutation ladders.]
    {The rules for refutation ladders. A modified version of Fig.~6 of Waaler and
    Wallen~\cite{waaler1999tableaux} with additional world inequality sidenotes and
    prefixes.  The top of a refutation ladder can be any sequent.
    No rule is branching.  Comma separated notation $\Gamma,\quad \mathsf
    s::\varphi$ denotes the disjoint union $\Gamma\uplus \{\mathsf
    s::\varphi\}$ in this figure.
    }
    \label{refladder}
  \end{figure}

  We are going to use a kind of tableau system called the refutation
  ladder in order to construct a finite model from an unprovable sequent.
  Refutation ladders have rules in Figure~\ref{refladder}.
  If the assumption of a rule is unprovable, so is the conclusion of the rule.
  A refutation ladder is not branching.

  Not all ladders made of the rules in Figure~\ref{refladder} are
  refutation ladders.
  There are some restrictions on the ladders.
  In order to describe the restrictions,
  we use a relation~$\prec$ between sequent occurrences in a ladder.
  Relation $T\prec S$ holds iff
  $S$ is above $T$, and
  at least one interleaving \textrm{R$\supset$} rule between $S$ and $T$
  has its left formula not introduced by thinning~(LT).
  \begin{definition}
   A refutation laddar\index{refutation ladder} is a ladder made of the rules in
   Figure~\ref{refladder} that satisfies
   \begin{description}
    \item[ (R1)]
	 If an \textrm{R$\supset$} occurrence
	 for a formula
	 $\mathsf s::\varphi\supset\psi$ has $\mathsf t\le \mathsf s$
	 in the sidenote of the assumption and
	 $\mathsf t::\varphi$ in the left hand side of the conclusion,
	 then,
	 there is a thinning just above the R$\supset$ introducing
	 $\mathsf w::\varphi$ where $\mathsf w$ is the world variable
	 introduced by the \textrm{R$\supset$} occurrence.
    \item[ (R2)]
	 Assume there are two \textrm{LC$\supset_0$} occurrences one above the
	 other.
	 Let $S$ be former occurrence's conclusion and $T$ be latter occurrence's
	 conclusion.
	 Then, $T\prec S$ holds.
    \item[ (R3)]
	 The conclusion of \textrm{R$\supset$} must not be a
	 possible conclusion of any other rule except (LT).
	 In other words, when building up a refutation ladder from
	 bottom to up, avoid using R$\supset$ whenever any other
	 rules except (LT) is applicable.
    \item[ (R4)]
	 For every sequent $\Theta\parallel \Gamma\rightarrow\Delta$
	 in the ladder, $\Theta$ conforms to~$\mathsf R$.
   \end{description}
  \end{definition}
  A refutation ladder of a sequent\index{refutation ladder!--- of a sequent}~$S$ is a refutation ladder
  with
  $S$ at the bottom.
  The conditions \textbf{(R1)} and \textbf{(R2)} ensure that every
  refutation ladder is finite~(\thref{refladder-finite}).

  \begin{proposition}
   \label{refladder-finite}
   Every refutation ladder is finite.  Moreover, the height of a
   refutation ladder is within a constant number for a given endsequent.
  \end{proposition}
  \begin{proof}
   If a refutation ladder is infinite,
   it must contain infinitely many $\supset$LC$_0$ occurrences because
   otherwise every rule strictly decreases the number of logical connectives from
   bottom to top.
   By \textbf{(R2)}, there must also be infinitely many R$\supset$ rule
   occurrences.
   Moreover, by the definition of~$\prec$,
   those occurrences have left-side formula not
   introduced by thinning.
   The number of such formulae is not more than the number of subformulae
   in the endsequent because thinning occurs whenever it is possible as
   \textbf{(R1)} states.
  \end{proof}

  \begin{definition}
   A complete refutation ladder\index{refutation ladder!complete} of~$S$ is a refutation ladder which is
   \begin{itemize}
    \item maximal\index{refutation ladder!maximal}
	  \index{maximal|see{refutation ladder}}
	  when the refutation ladder is not a proper sub-ladder of any
	  refutation ladder of~$S$
    \item open\index{refutation ladder!open}\index{open|see{refutation ladder}} when,
	  for any sequent~$\Theta\parallel \Gamma\longrightarrow \Delta$,
	  the prefixed formula~$\mathsf t::\bot$ is not contained
	  in~$\Gamma$, and at least one of
	  $\mathsf t::\varphi\notin \Gamma$,
	  $\mathsf s::\varphi\notin\Delta$ or $\mathsf t\le \mathsf s\notin
	  \Theta$ hold.
   \end{itemize}
  \end{definition}

  We are going to show that
  if a sequent $S$ is not provable in\,\LB, then there is a complete
  refutation ladder of $S$, and then there is a finite counter model.

   \subsection{Existence of a Complete Refutation Ladder}

   \begin{proposition}\label{chooser}
    If a sequent~$S$ does not form a maximal refutation ladder by itself and
    every applicable rule to $S$ yields a provable
    sequent in \LB, then $S$ is provable in \LB.
   \end{proposition}
   \begin{proof}
    At least one rule is applicable to $S$ because the sequent does
    not form a maximal refutation ladder by itself. We split cases by the
    applicable rule.
    \begin{description}
     \item[ (Case L$\wedge$ R$\vee$ L$a$ R$a$)]
	  If the above is provable, then so is the below.
     \item[ (Case R$\wedge_0$)]
	  R$\wedge_1$ is also applicable.
     \item[ (Case R$\wedge_1$)]
	  In this case, we use the fact that R$\wedge_0$ is also
	  applicable.
	  Since $\Theta\parallel\Gamma\longrightarrow \mathsf t::\varphi, \Delta$ and
	  $\Theta\parallel\Gamma\longrightarrow \mathsf t::\psi,
	  \Delta$ are both provable in \LB,
	  $\Theta\parallel\Gamma\longrightarrow \mathsf
	  t::\varphi\land\psi$ is also provable in \LB.
     \item[ (Case L$\vee_0$ L$\vee_1$)]
	  Similar to the R$\wedge$ cases.
     \item[ (Case L$\supset_1$ Split)] Immediate.
     \item[ (Case LC$\supset_0$)]
	  L$\supset_1$ is also applicable.
     \item[ (Case R$\supset$)]
	  The rule is also applicable with any $\Theta'\in
	  \mathsf R(\Theta\cup\{\mathsf s\le \mathsf w\})$. Since every one of these is
	  provable in \LB,
	  the endsequent is also provable in \LB.
     \item[ (Case LT)] Immediate.
    \end{description}
   \end{proof}

   For a refutation ladder~$l$, we define a sequent $\cup l$ as
   the sequent $\left(\bigcup_i \Theta_i\right)\parallel \left(\bigcup_i \Gamma_i\right)\longrightarrow
   \left(\bigcup_i\Delta_i\right)$ where $i$ runs over
   each sequent $\Theta_i\parallel \Gamma_i\longrightarrow\Delta_i$
   occurring in~$l$.
   We say $l$ is unprovable\index{unprovable} when $\cup l$ is
   unprovable in \LB.

   \begin{proposition}
    \label{comprefl}
    An unprovable sequent has a complete refutation ladder.
   \end{proposition}
   \begin{proof}
    Assume the sequent
    $S = \Theta\parallel \Gamma\longrightarrow\Delta$
    is unprovable.
    Let $L$ be the set of refutation ladders of~$S$ and
    let $\overline L$ be the set of maximal refutation ladders in $L$.
    We collect unprovable refutation ladders in~$L$ and call them~$L_u$.
    Again, $\overline L_u$ denotes the maximal elements of~$L_u$.
    The ladder consisting of only~$S$ is an element of~$L_u$
    so that $L_u$ is not empty.
    Moreover, every refutation ladder in~$L_u$ is finite.
    We claim that
    $\overline L_u$ is not empty: on the contrary,
    suppose $\overline{L_u}$ is empty, then any element of $L_u$ is not
    maximal, meaning that it can be extended upwards and turned into
    another element of $L_u$ by \thref{chooser} so, $L_u$ contains
    arbitrarily tall refutation ladders.  This contradicts
    \thref{refladder-finite} because we have already fixed an
    endsequent~$S$.
    Thus,
    there is an unprovable ladder~$l$ in~$\overline L$.
    Since $l$ is unprovable, $l$ is open: otherwise, $\cup l$ would
    become an axiom and hense $l$ would be provable.
    We conclude that $l$ is a complete refutation ladder.
   \end{proof}


   \subsection{Constructing a Model from a Complete Refutation Ladder}

   \begin{definition}[Hintikka Sequent]
    A sequent $\Theta\parallel \Gamma\longrightarrow\Delta$ is $\mathsf R$-Hintikka
    iff
    \begin{enumerate}
     \item $\Theta$ conforms to $\mathsf R$.
     \item $\Gamma$ does not contain $\mathsf s::\bot$ for any world
	   term~$\mathsf s$.
     \item If $\mathsf s::P\in \Gamma$ and $\mathsf t::P\in\Delta$ for
	   some~$P\in\pvar$\!, then
	   $\Theta$ does not contain~$\mathsf s\le \mathsf t$.
     \item $\mathsf s::\varphi\land\psi\in\Gamma\Longrightarrow
	   \mathsf s::\varphi,\mathsf s::\psi\in\Gamma$
     \item $\mathsf s::\varphi\vee\psi\in\Gamma
	   \Longrightarrow \mathsf s::\varphi\in\Gamma$ or
	   $\mathsf s::\psi\in\Gamma$.
     \item If $\mathsf t::\varphi\supset\psi
	   \in\Gamma$ and $\mathsf s\ge t\in \Theta$,
	   then
	   either
	   $\mathsf t::\varphi\in\Gamma$ or
	   $\mathsf s::\psi\in\Delta$ hold.
     \item $\mathsf s::K_a\varphi\in\Gamma
	   \Longrightarrow \mathsf s.a::\varphi\in\Gamma$
     \item $\mathsf s::\varphi\land\psi
	   \in\Delta\Longrightarrow \mathsf
	   s::\varphi\in\Delta$
	   or $\mathsf s::\psi\in\Delta$.
     \item $\mathsf s::\varphi\vee\psi\in\Delta
	   \Longrightarrow \mathsf s::\varphi, \mathsf s::\psi\in
	   \Delta$.
     \item If $\mathsf s::\varphi\supset\psi\in\Delta\Longrightarrow$, then
	   there exists a world term $\mathsf t$ with $\mathsf
	   s\le \mathsf t\in\Theta$ such that
	   $\mathsf t::\varphi\in\Gamma$, $\mathsf t::\psi\in\Delta$.
     \item $\mathsf s:: K_a\varphi\in\Delta\Longrightarrow
	   \mathsf s.a::\varphi\in\Delta$.
    \end{enumerate}
   \end{definition}

   \begin{proposition}
    \label{Hsat}
    A $\mathsf R$-Hintikka sequent is satisfiable in a finite $\mathsf R$-model.
   \end{proposition}
   \begin{proof}
    \newcommand{\W}{WT(\Theta)}
    Let $\Theta\parallel \Gamma\longrightarrow\Delta$ be a Hintikka sequent.
    To construct a satisfying model, we use $\W$,
    which is the set of world
    terms occurring in~$\Theta$.
    We define a frame $\tuple{\W, \preceq, (f_a)_{a\in\agents}}$ with
    $\preceq$ being the relation $\{\tuple{\mathsf s,\mathsf t}\in
    \W\times \W\mid
    \mathsf s\le
    \mathsf t\in\Theta\}$ and
    $f_a(\mathsf s) = \mathsf s.a$ for $\mathsf s\in\W$\enspace.
    Since $\Theta$ conforms to $\mathsf R$,
    the tuple is actually an $\mathsf R$-frame.
    We define $\rho$ to be $\rho(P) =
    \{\mathsf s\in \W\mid
    \mbox{there exists a world term } \mathsf t \in \W \mbox{ such that }
    \mathsf t\le
    \mathsf s \in \Theta\mbox{
    and }\mathsf t::P\in \Gamma\}$.
    The tuple $\tuple{\W,\preceq,(f_a)_{a\in \agents},\rho}$ forms
    an $\mathsf R$-model because $\Theta$ conforms to $\mathsf R$.
    Moreover, by induction on $\varphi$, we can show both
    $\mathsf s::\varphi\in\Gamma\Longrightarrow M,\mathsf s\models\varphi$
    and
    $\mathsf s::\varphi\in\Delta\Longrightarrow M,\mathsf s\not\models\varphi$.
    Thus, the sequent $\Theta\parallel \Gamma\longrightarrow\Delta$ is satisfiable.
   \end{proof}

   \begin{proposition}
    \label{completehintikka}
    For a complete refutation ladder~$l$,
    $\cup l$ is a Hintikka sequent.
   \end{proposition}
   \begin{proof}
    By openness, maximality and rules \textbf{(R2)}, \textbf{(R3)}.
   \end{proof}

   \begin{proposition}
    \label{R-fmp}
    If $\vdashR\varphi$  does not hold, there exists a finite $\mathsf
    R$-model~$M$ with $M\not\models\varphi$.
   \end{proposition}
   \begin{proof}
    Assume $\not\vdashR\varphi$.
    By soundness of \LB,
    the sequent $\mathsf w\le\mathsf w\parallel \longrightarrow\varphi$ is not
    provable in \LB.
    By \thref{comprefl},
    there is a complete refutation ladder~$l$ for the sequent.
    By \thref{refladder-finite}, $l$ is finite.
    By \thref{completehintikka},
    $\cup l = l$  forms a Hintikka
    sequent.
    Moreover,
    the union $\bigcup_i\Theta_i$ conforms to~$\mathsf
    R$.
    Thus, when we construct a model from $\cup l$ with the method described in
    the proof of \thref{Hsat},
    we obtain a finite $\mathsf R$-model.
    Moreover, the state $\mathsf w$ of the model does not satisfy~$\varphi$.
   \end{proof}
  \subsection{Completeness}
  We prove completeness via
  adaptation of the standard saturated set construction (see Troelstra
  and van Dalen~\cite[Ch.~2]{troelstra1988constructivism}).
  Hirai~\cite{hirailpar} contains a similar proof for a special case of
  sequential consistency logic.

  \begin{definition}
   A set~$\Gamma$ of formulae is
   $\mathsf R$-saturated iff all of these conditions hold:
   \begin{enumerate}
    \item $\Gamma$ does not contain $\bot$;
    \item $\Gamma$ is closed under $\mathsf R$-deduction, i.e.,
	  $\Gamma\vdashR\varphi\Rightarrow\varphi\in\Gamma$;
    \item $\varphi\vee\psi\in\Gamma\Rightarrow\varphi\in\Gamma$ or $\psi\in\Gamma$.
   \end{enumerate}
  \end{definition}

  \begin{proposition}
   \label{hoe:saturation}
   For a set~$\Gamma$ of formulae with $\Gamma\not\vdashR\varphi$,
   there exists a
   saturated set $\Gamma^{\omega}$ of formulae with
   $\Gamma^{\omega}\not\vdashR\varphi$ and
   $\Gamma\subseteq \Gamma^{\omega}$.
  \end{proposition}
  \begin{proof}
   Exactly the same as Lemma~2.10 in Hirai~\cite{hirailpar}.
  \end{proof}


  \begin{definition}[Canonical model candidate]
   We define a tuple
   $\R M = \tuple{\R W, \R\preceq, (\R{f_a})_{a\in \agents}, \R\rho}$
   where
   \begin{itemize}
    \item $\R W$ is the set of $\mathsf R$-saturated sets of formulae;
    \item $\Gamma\R\preceq \Delta$ iff $\Gamma\subseteq\Delta$;
    \item $\R{f_a}(\Gamma) = \{\varphi\mid K_a\varphi\in\Gamma\}$;
    \item $\R\rho(P)=\{\Gamma\mid P\in \Gamma\}$.
   \end{itemize}
  \end{definition}

  \begin{proposition}
   The tuple $\R M$ is a model.
  \end{proposition}
  \begin{proof}
   Exactly the same as Lemma~2.11 in Hirai~\cite{hirailpar}.
  \end{proof}

  \begin{proposition}
   \label{X}
   For a saturated set~$\Gamma$ of formulae and the canonical model~$\R
   M$,
   $\varphi\in\Gamma\Leftrightarrow \R M,\Gamma\models\varphi$ holds.
  \end{proposition}
  \begin{proof}
   Exactly the same as Lemma~2.13 in Hirai~\cite{hirailpar}.
  \end{proof}

  \begin{definition}
   A frame~$F = \tuple{W,\preceq, (f_a)_{a\in\agents}}$
   is a pseudo $\mathsf R$-frame iff $F$ satisfies
   $\delta(\mathsf R)$ for all world valuation
   $\delta$ and $w\in W$ s.t.
   every world variable~$\mathsf v$ satisfies
   $w\preceq \delta(\mathsf v)$.
  \end{definition}
  A pseudo $\mathsf R$-model is a model with a pseudo $\mathsf R$-frame.

  \begin{proposition}
   \label{pseudo-real}
   For a pseudo $\mathsf R$-model~$M$ and a state $w$ of $M$ with
   $M,w\models\varphi$,
   there exists an $\mathsf R$-model $\overline M$ and a state $\overline w$
   with $\overline M,\overline w\models\varphi$.
  \end{proposition}
  \begin{proof}
   A deep postfix is a postfix~$s$ that contains any sequence of agents
   encountered during parsing~$\varphi$ in the top-down direction.
   Let $s$ be a deep postfix for~$\varphi$. Let $M$ be
   $\tuple{W,\preceq,(f_a)_{a\in\agents},\rho}$.
   We define $\overline M$ to be $\tuple{\overline W,\overline\preceq,
   (\overline f_a)_{a\in\agents},\overline \rho}$ where
   $\overline W=\{v\in W\mid v\succeq f_s(w)\}$,$\overline\preceq =
   \preceq\cap (\overline W\times\overline W)$,
   $\overline f_a(w)= \begin{cases}
		  f_a(w)&(\mbox{if }f_a(w)\in\overline W)\\
		  w&(\mbox{otherwise})\enspace,
		 \end{cases}$
   and $\overline \rho(P) =\rho(P)\cap\overline W$.
   We define $\overline w$ to be $w$.
   The new model~$\overline M$ simulates the original model~$M$ well enough
   to make $\overline M,\overline w\models\varphi$ hold.
   Since $\overline M$ is a restriction of $M$, $\overline M$ is a pseudo
   $\mathsf R$-model.
   Moreover, since $\overline M$ has the minimum state, $\overline M$ is an
   $\mathsf R$-model.
  \end{proof}

  \begin{proposition}
   $\R M$ is a pseudo $\mathsf R$-model.
  \end{proposition}
  \begin{proof}
   Seeking contradiction,
   assume the frame $\R F = \tuple{\R W, \R\preceq, (\R
   {f_a})_{a\in\agents}}$
   does not satisfy $\delta(\mathsf R)$ for
   a world valuation~$\delta$ with
   $\Delta\R\preceq\delta(\mathsf v)$ for all $\Delta\in\R W$.
   There exists a world restriction
   $\mathsf r\in\mathsf R$.
   Let $\mathsf r$ be $\mathsf v_0.s\le\mathsf v_1.s\wor\cdots \wor\mathsf
   v_{n-1}.s\le\mathsf v_n.s\wor\mathsf v_n.s\le\mathsf v_0.s$.
   Since $\R F$ does not satisfy $\delta(\mathsf r)$,
   $f_s(\delta(\mathsf v_i))\not{\R \preceq}f_s(\delta(\mathsf v_{i+1}))$
   for
   all $0\le i\le n$ (we define $\mathsf v_{n+1} = \mathsf v_0$).
   Since $\R\preceq = \subseteq$, there exists
   a formula $\psi_i\in f_s(\delta(\mathsf v_{i+1}))\setminus
   f_s(\delta(\mathsf v_i))$ for every $0\le i\le n$.
   In other words, $K_s\psi_i\in\delta(\mathsf v_{i+1})$
   but $K_s\psi_i\notin\delta(\mathsf v_i)$.
   By \thref{X},
   $\R M,\delta(\mathsf v_{i+1})\models K_s\psi_i$ but
   $\R M,\delta(\mathsf v_{i})\not\models K_s\psi_i$.
   On the other hand, $\mathbf{Ax}(\mathsf R)$ contains
   $\bigvee_{0\le i\le n}\left(K_s\psi_i\supset K_s\psi_{i+1}\right)$.
   So, for some $0\le i\le n$,
   $K_s\psi_i\supset K_s\psi_{i+1}\in\Delta$.
   This means, by \thref{X},
   $\R M,\Delta\models K_s\psi_i\supset K_s\psi_{i+1}$.
   Since $\Delta\R\preceq\delta(\mathsf v_i)$,
   by Kripke monotonicity (\thref{monot}),
   $\R M,\delta(\mathsf v_{i+1})\models K_s\psi_i\supset K_s\psi{i+1}$.
   This contradicts $\R M,\delta(\mathsf v_{i+1})\models K_s\psi_i$ and
   $\R M,\delta(\mathsf v_i)\not\models K_s\psi_i$.
  \end{proof}

  \begin{lemma}[Completeness]
   $\modelsR\varphi\Longrightarrow\vdashR\varphi$
  \end{lemma}
  \begin{proof}
   We show the contraposition.
   Assume $\not\vdashR \varphi$. By
   \thref{hoe:saturation}, there exists
   a saturated set~$\Gamma^\omega$ with $\Gamma^\omega\not\vdashR\varphi$.
   By \thref{X}, $\R M, \Gamma^\omega\not\models\varphi$.
   By \thref{pseudo-real}, there exists an
   $\mathsf R$-model $\overline M$ and a state~$\overline w$ of $\overline M$
   with $\overline M,\overline w\not\models \varphi$.
   This witnesses $\not\modelsR\varphi$.
  \end{proof}

   Now we can carry out the proof strategy for \thref{thm:fmp} described
   at the beginning of Section~\ref{fmp-proof}.

  \section{Application to Sequential Consistency Logic}

  Sequential consistency logic can be defined with the following world
  restrictions:
  \begin{itemize}
   \item $\mathsf v.a\le\mathsf v.a.a$ for all $a\in\agents$,
   \item $\mathsf v.a\le\mathsf v$ for all $a\in\agents$,
   \item $\mathsf v.m\le\mathsf w.m\wor\mathsf w.m\le\mathsf v.m$ where $m\in\agents$ is a special
	 agent called shared memory.
  \end{itemize}

  Let us consider a formula $K_a K_m K_a P\supset K_a K_m K_b Q\supset
  (K_a Q\wedge K_b P)$.
  Informally, this formula means that whenever processes $a$ and $b$ have
  made a round-trip communication with the shared memory, each process is
  guaranteed to have received the other process's initial knowledge (with
  an assumption a message carries all of sender's knowledge).
  We can build a countermodel for this formula by the method described in
  this paper, by building
  a complete refutation ladder for the formula~(Figure~\ref{compex})
  \begin{sidewaysfigure}
   \def\fCenter{\longrightarrow}
   \begin{center}
    \Axiom$cl(\Theta_2, \mathsf x.b.m.b\le\mathsf x.b.m, \mathsf
    x.a\le\mathsf x)\parallel\mathsf v.a.m.a::P, \mathsf
    x.b.m.b::Q\fCenter \mathsf x.a::Q$
    \RightLabel{R$a$}
    \UnaryInf$cl(\Theta_2,\mathsf x.b.m.b\le\mathsf x.b.m)\parallel\mathsf
    v.a.m.a::P, \mathsf x.b.m.b::Q\fCenter\mathsf x::K_a Q$
    \RightLabel{R$\wedge_0$}
    \UnaryInf$cl(\Theta_2, \mathsf x.b.m.b\le\mathsf
    x.b.m)\parallel\mathsf v.a.m.a::P, \mathsf x.b.m.b::Q\fCenter\mathsf
    x::K_a Q\wedge K_a P$
    \RightLabel{L$b$}
    \UnaryInf$\Theta_2=cl(\Theta_1,\mathsf x.b\le\mathsf x,\mathsf
    x.b.m\le\mathsf x.b,\mathsf v.a.m\le\mathsf x.b.m)\parallel\mathsf
    v.a.m.a::P, \mathsf x.b.m::K_b Q\fCenter \mathsf x::K_a Q\wedge K_b P$
    \RightLabel{L$b$}
    \UnaryInf$cl(\Theta_1, \mathsf x.b\le\mathsf x)\parallel
    \mathsf v.a.m.a::P, \mathsf x.b::K_m K_b Q\fCenter x::K_a Q\wedge K_b
    P$
    \RightLabel{L$b$}
    \UnaryInf$\Theta_1=cl(\Theta_0,\mathsf v\le\mathsf x, \mathsf
    v.a.m.a\le \mathsf v.a.m)\parallel\mathsf v.a.m.a::P, \mathsf x::K_b
    K_m K_b Q\fCenter x::K_a Q\land K_b P$
    \RightLabel{R$\supset$}
    \UnaryInf$cl(\Theta_0,\mathsf v.a.m.a\le\mathsf v.a.m)\parallel
    \mathsf v.a.m.a::P\fCenter \mathsf v:: K_b K_m K_b Q\supset (K_a
    Q\land K_b P)$
    \RightLabel{L$a$}
    \UnaryInf$\Theta_0=cl(\mathsf w\le\mathsf v, \mathsf v.a\le\mathsf v,
    \mathsf v.a.m\le\mathsf v.a)\parallel\mathsf v.a.m::K_a P\fCenter
    \mathsf v::K_b K_m K_b Q\supset (K_a Q\land K_b P)$
    \RightLabel{L$a$}
    \UnaryInf$cl(\mathsf w\le\mathsf v, \mathsf v.a\le\mathsf
    v)\parallel\mathsf v.a::K_m K_a P\fCenter \mathsf v::K_b K_m K_b
    Q\supset (K_a Q\land K_b P)$
    \RightLabel{L$a$}
    \UnaryInf$cl(\mathsf w\le\mathsf v)\parallel \mathsf v:: K_a K_m K_a P
    \fCenter \mathsf v:: K_b K_m K_b Q\supset (K_a Q\land K_b P)$
    \RightLabel{R$\supset$}
    \UnaryInf$\mathsf w\le \mathsf w\parallel\fCenter \mathsf w:: K_a K_m K_a
    P\supset K_b K_m K_b Q\supset (K_a Q\land K_b P)$
    \DisplayProof
   \end{center}
   \caption
   {A complete refutation ladder for the considered formula $K_a K_m K_a P\supset K_a K_m K_b Q\supset
  (K_a Q\wedge K_b P)$.
   $cl(\Theta)$ denotes the reflexive transitive closure
   of~$\Theta$. \fix{check the derivation}}
   \label{compex}
  \end{sidewaysfigure}


 \section{Related Work}

    \paragraph{Work on intuitionistic modal logics.}

    Amati and Pirri~\cite{amati94} presented a uniform tableau method for a number of
    intuitionistic modal logics whose language contains two modalities
    $\square$ and $\lozenge$.
    However, they did not consider the functional modality where the two
    modalities coincide.  Nor did they consider the multimodal case.
    Their uniform tableau method uses boxes around some sequents of the
    tableaux.  This boxing method does not trivially encode our tableaux since our
    tableau method utilizes sequents whose different formulae are prefixed
    with different world terms.

    Baldoni, Giordano and Martelli~\cite{baldoni98} presented a tableau
    calculus for a class of multimodal logics called grammar logics.
    Their method is similar to our method in that worlds are denoted by
    variables and the relationship between the worlds are kept as a
    sidenote.
    However, their method does not parametrize logics with conditions involving
    disjunction while our method parametrizes logics with conditions
    involving $\wor$.

    \paragraph{Work on intermediate logics.}

    Avron~\cite{avron2000} presented a tableau system of G\"odel--Dummett logic
    based on a hypersequent calculus.
    As he points out, the system has an advantage of not using a rule with
    arbitrary number of
    premises.  Our tableau system does not have this advantage.
    Larchey-Wendling~\cite{countermodelsearch} proposes an efficient parallel
    countermodel searching method for G\"odel--Dummett logic.
    It would be interesting to try to extend their methods to the
    class of logics considered in this chapter.

    Sonobe~\cite{sonobe} gave a Gentzen-style formulation of some
    intermediate logics, the simplest of which is G\"{o}del--Dummett logic.
    He wrote his result ``was first obtained by way of tableau method.''
    Thus both Sonobe's and our method contain a tableau formalization for
    G\"{o}del--Dummett logic.  However, there are some differences even when
    we compare Sonobe's formalization of G\"odel--Dummett logic and our
    specialized method for G\"odel--Dummett logic.
    In our formalization\,\LB, branches are for different shapes of Kripke
    frames.  In Sonobe's formalization, branches are made for different
    states in a Kripke model.

 \section{Conclusion}

 We have generalized Waaler and Wallen's tableau method~\cite{waaler1999tableaux} for intuitionistic
 logic in two ways: adding functional modalities, and adding restrictions on the Kripke frames.
 This resulted in the finite model property of sequential consistency
 logic~\cite{hirailpar} and a class of intermediate logics with
 functional modalities.
